# LLM Image Tagging Workflow

This document outlines the process for tagging facial expressions in untagged images using the Google Gemini API.

## 1. Objective
To automatically assign one of the allowed emotion labels to a dataset of images containing faces. This is a crucial step before extracting landmarks for training the emotion classification model.

## 2. Allowed Emotion Tags
The training pipeline (`train_model_combined.py`) and the API script enforce the following **strict** list of emotions:

*   `happy`
*   `surprise`
*   `angry`
*   `disgust`
*   `fear`
*   `neutral`
*   `sad`

*Note: Mappings for other terms (e.g., 'serious' -> 'neutral') are handled in the training script, but the tagger attempts to adhere strictly to this list.*

## 3. Workflow

### A. Setup
Ensure your environment is configured with the `AI_STUDIO_API_KEY`.
The `auto_tag_images.py` script uses `settings.py` to load this from your system keyring or `.env` file.

### B. Running the Tagger
The script `auto_tag_images.py` iterates through a specified folder of images, sends them to the Gemini API, and records the predicted expression.

**Command:**
```bash
python auto_tag_images.py
```

**Configuration:**
You can modify the `TARGET_FOLDER` variable in `auto_tag_images.py` to point to your specific image directory (e.g., `dataset/random_expressions`).

### C. Output
The script generates a CSV file (default: `dataset/llm_labels.csv`) with the following columns:
*   `filename`: The name of the image file.
*   `path`: The absolute path to the image.
*   `emotion`: The detected emotion (lowercased).
*   `confidence`: (Optional) The model's confidence if available, or just the raw confirmation.

### D. Integration with Training
The standard `extract_landmarks.py` script currently parses emotion tags from **filenames** (e.g., `male_young_happy.png`).

To use the CSV labels generated by the LLM:
1.  **Option 1 (Recommended):** Modify `extract_landmarks.py` to read `llm_labels.csv` and look up the emotion for each file instead of parsing the filename.
2.  **Option 2:** Rename your files based on the CSV content to match the `sex_age_ethnicity_emotion.png` format.

## 4. Script Logic (`auto_tag_images.py`)
1.  **Discovery:** Uses `helpers.folder_tools` to safely find images recursively.
2.  **API Call:** Uses the `google-genai` SDK (v1.0+) to send the image to `gemini-1.5-flash`.
3.  **Prompting:** Instructs the model to act as an expert annotator and return strictly one word from the allowed list.
4.  **Resilience:** Handles API errors and rate limits (basic retry logic).
